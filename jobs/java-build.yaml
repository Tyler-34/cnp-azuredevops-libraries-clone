parameters:
  serviceConnection: ''

jobs:
- job: JavaBuild
  dependsOn: LaunchAgent
  pool:
    name: 'mgmt-aks-sandbox'
    demands:
    - agent.name -equals $(projectName)-$(Build.BuildId)

  steps:
  - script: 'env'
    displayName: 'Display Environment Variables'

  - template: ../tasks/install-os-dependencies.yaml

  - task: AzureKeyVault@1
    displayName: 'Get secrets from Keyvault'
    inputs:
      azureSubscription: ${{ parameters.serviceConnection }}
      keyVaultName: 'infra-vault-sandbox'
      secretsFilter: 'sonarcloud-api-token,OWASPDb-Account,OWASPDb-Password'

  - template: ../tasks/gradle-assemble.yaml

  - template: ../tasks/sonarcloud-build-breaker.yaml

  - template: ../tasks/owasp-security-check.yaml

  - template: ../steps/acr-build.yaml
    parameters:
      serviceConnection: ${{ parameters.serviceConnection }}