parameters:
  serviceConnection: ''

jobs:
- job: JavaBuild
  dependsOn: LaunchAgent
  pool:
    name: 'mgmt-aks-sandbox'
    demands:
    - agent.name -equals $(projectName)-$(Build.BuildId)

  steps:
  - script: 'env'
    displayName: 'Display Environment Variables'

  - task: AzureKeyVault@1
    displayName: 'Get secrets from Keyvault'
    inputs:
      azureSubscription: ${{ parameters.serviceConnection }}
      keyVaultName: 'infra-vault-sandbox'
      secretsFilter: 'sonarcloud-api-token,OWASPDb-Account,OWASPDb-Password'

  - task: Gradle@2
    displayName: 'Build and SonarQube'
    enabled: true
    inputs:
      workingDirectory: ''
      gradleWrapperFile: 'gradlew'
      gradleOptions: '-Xmx3072m'
      javaHomeOption: 'JDKVersion'
      jdkVersionOption: '1.8'
      jdkArchitectureOption: 'x64'
      publishJUnitResults: true
      testResultsFiles: '**/TEST-*.xml'
      sonarQubeRunAnalysis: true
      options: '-Dsonar.host.url=https://sonarcloud.io -Dsonar.login=$(sonarcloud-api-token) -Dsonar.organization=hmcts'
      tasks: 'assemble'
